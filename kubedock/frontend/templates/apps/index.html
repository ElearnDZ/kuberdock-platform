<!DOCTYPE html>
<html lang="en">
    <head>
        <title>{{ name }}</title>
        <meta charset="utf8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon" />
{#
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-editable.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.jqplot.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-select.min.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/dropdowns-enhancement.min.css') }}">

        <link rel="stylesheet/less" type="text/css" href="{{ url_for('static', filename='css/main.less') }}">

        <script src="{{ url_for('static', filename='js/lib/less.min.js') }}" type="text/javascript"></script>
#}
    <style type="text/css">
    html, body, div, span, object, iframe,
    h1, h2, h3, h4, h5, h6, p, blockquote, pre,
    abbr, address, cite, code,
    del, dfn, em, img, ins, kbd, q, samp,
    small, strong, sub, sup, var,
    b, i,
    dl, dt, dd, ol, ul, li,
    fieldset, form, label, legend,
    table, caption, tbody, tfoot, thead, tr, th, td,
    article, aside, canvas, details, figcaption, figure,
    footer, header, hgroup, menu, nav, section, summary,
    time, mark, audio, video {
        margin:0;
        padding:0;
        border:0;
        outline:0;
        font-size:100%;
        vertical-align:baseline;
        background:transparent;
    }
    body {line-height:1;}
    article,aside,details,figcaption,figure,
    footer,header,hgroup,menu,nav,section {display:block;}
    nav ul {list-style:none;}
    blockquote, q {quotes:none;}
    blockquote:before, blockquote:after,
    q:before, q:after {
        content:'';
        content:none;
    }
    a {
        margin:0;
        padding:0;
        font-size:100%;
        vertical-align:baseline;
        background:transparent;
    }
    ins {
        background-color:#ff9;
        color:#000;
        text-decoration:none;
    }
    mark {
        background-color:#ff9;
        color:#000;
        font-style:italic;
        font-weight:bold;
    }
    del {text-decoration: line-through;}
    abbr[title], dfn[title] {
        border-bottom:1px dotted;
        cursor:help;
    }
    table {
        border-collapse:collapse;
        border-spacing:0;
    }
    hr {
        display:block;
        height:1px;
        border:0;
        border-top:1px solid #cccccc;
        margin:1em 0;
        padding:0;
    }
    input, select {vertical-align:middle;}

    /* custom styles */
    div#select-controls {margin: 7em 0 0 20em;}
    div#custom-fields {
        margin: 1em 0 0 20em;
        width: 30em;
    }
    div#resource-list {
        margin: 0 0 0 20em;
        width: 30em;
    }
    div.custom-field-title {
        background-color: #E5E5E5;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        text-align: center;
        padding: .2em;
    }
    div.custom-field-item {
        margin: .2em 0 .2em 0;
        border: 1px solid #C9C9C9;
        border-radius: 4px;
    }
    div.custom-field-body {padding: .4em;}
    div#controls {
        margin: 0 0 0 20em;
        padding: .4em 0;
        width: 30em;
        text-align: center;
    }
    div#total-price {
        margin: 0 0 0 20em;
        height: 2em;
    }
    </style>
    </head>
    <body>
        <div id="select-controls">
            {#
            <div>
                <label for="package-selector">Select package</label>
                <select id="package-selector">
                    {% for package in packages %}
                    <option value="{{ package.id }}">{{ package.name }}</option>
                    {% endfor %}
                </select>
            </div>
            #}
        </div>
        <div id="total-price"></div>
        <div id="resource-list"></div>
        <div id="custom-fields">
            {% for k, v in fields.iteritems() %}
            <div class="custom-field-item">
                <div class="custom-field-title">{{ v.title }}</div>
                <div class="custom-field-body">
                    {% if v.hashsum in mutables and mutables[v.hashsum]['type'] == 'kube' %}
                    <select id="{{ v.hashsum }}" class="custom-field">
                        {% for row in range(1, 11) %}
                            {% if row == v.value|int %}
                            <option selected="selected" value="{{ row }}">{{ row }}</option>
                            {% else %}
                            <option value="{{ row }}">{{ row }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% elif v.hashsum in mutables and mutables[v.hashsum]['type'] == 'kube_type' %}
                    <select id="{{ v.hashsum }}" class="custom-field">
                        {% for row in kubes_data[package_id] %}
                            {% if row.id == kube_type %}
                            <option selected="selected" value="{{ row.id }}">{{ row.name }}</option>
                            {% else %}
                            <option value="{{ row.id }}">{{ row.name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    {% else %}
                    <input id="{{ v.hashsum }}" class="custom-field" type="text" value="{{ v.value }}">
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <div id="controls"><button id="submit-button">Order now</button></div>
        <input type="hidden" value="{{ template }}" id="template-data">
        <script type="text/javascript">
            'use strict;'
            var fields = {{ jfields|safe }},
                mutables = {{ jmutables|safe }},
                kubes = {{ kubes|safe }},
                kubeType = {{ kube_type|int }},
                packageId = {{ package_id|int }},
                kubesData = {{ jkubes_data|safe }},
                packages = {{ jpackages|safe }},
                templateField = document.getElementById('template-data'),
                packageSelector = document.getElementById('package-selector'),
                billingUrl = {{ '"{0}"'.format(billing_url)|safe }},
                submitButton = document.getElementById('submit-button'),
                customFields = document.getElementsByClassName('custom-field'),
                totalPrice = document.getElementById('total-price'),
                resourceList = document.getElementById('resource-list');

            function empty(n){while(n.firstChild){n.removeChild(n.firstChild)}}

            function composeResources(kubeId){
                empty(resourceList);
                var kubeItem = getKubeById(kubeId),
                    data = ['c','m','d'].map(function(i){return document.createElement('div')});
                data[0].appendChild(document.createTextNode('CPU:'+String.fromCharCode(160)+kubeItem.cpu+kubeItem.cpu_units));
                data[1].appendChild(document.createTextNode('Memory:'+String.fromCharCode(160)+kubeItem.memory+kubeItem.memory_units));
                data[2].appendChild(document.createTextNode('Disk:'+String.fromCharCode(160)+kubeItem.disk_space+kubeItem.disk_space_units));
                data.forEach(function(el){resourceList.appendChild(el)});
            }

            function displayTotal(value) {
                empty(totalPrice);
                totalPrice.appendChild(document.createTextNode('Total:'+String.fromCharCode(160)+value));
            }

            function recalculate(tgt){
                console.log(getKubeId());
                if (tgt.id in mutables && mutables[tgt.id].type === 'kube') {
                    var price = getKubeById(getKubeId()).price || 0,
                        fixed = kubes.reduce(function(a, b){return (+a)+(+b)}, 0),
                        changing = Object.keys(mutables)
                            .filter(function(k){return k !== tgt.id})
                            .map(function(k){return document.getElementById(k).value})
                            .reduce(function(a, b){return (+a)+(+b)}, 0);
                    displayTotal(getPackage(packageId).prefix + ((fixed + changing + (+tgt.value)) * price));
                }
                else if (tgt.id in mutables && mutables[tgt.id].type === 'kube_type') {
                    var price = getKubeById(+tgt.value).price || 0,
                        fixed = kubes.reduce(function(a, b){return (+a)+(+b)}, 0),
                        changing = Object.keys(mutables)
                            .filter(function(k){return mutables[k].type === 'kube'})
                            .map(function(k){return document.getElementById(k).value})
                            .reduce(function(a, b){return (+a)+(+b)}, 0);
                    displayTotal(getPackage(packageId).prefix + ((fixed + changing) * price));
                    composeResources(+tgt.value);
                }
            }

            function getPackage(packageId){
                for (var i in packages) {
                    if (packages[i].id === packageId) {
                        return packages[i];
                    }
                }
            }

            function getKubeId(){
                for (var id in mutables) {
                    if (mutables[id].type == 'kube_type') {
                        return +document.getElementById(id).value;
                    }
                }
                return kubeType;
            }

            function getKubeById(kubeId){
                for (var i in kubesData) {
                    for (var j in kubesData[i]) {
                        if (kubesData[i][j].id == kubeId) {
                            return kubesData[i][j];
                        }
                    }
                }
            }

            (function(){
                var price = getKubeById(getKubeId()).price || 0,
                    fixed = kubes.reduce(function(a, b){return (+a)+(+b)}, 0),
                    changing = Object.keys(mutables)
                        .filter(function(k){return mutables[k].type === 'kube'})
                        .map(function(k){return document.getElementById(k).value})
                        .reduce(function(a, b){return (+a)+(+b)}, 0);
                displayTotal(getPackage(packageId).prefix + ((fixed + changing) * price));
                composeResources(getKubeId());
            }());

            Array.prototype.forEach.call(customFields, function(f){
                f.onchange = function(evt){recalculate(evt.target)}
            });

            submitButton.onclick = function(evt){
                if (!billingUrl) {
                    alert('Billing URL not set!');
                    return;
                }
                var yml = templateField.value;
                yml = yml.replace(/\$[^$]+\$/g, function(field){
                    return document.getElementById(fields[field].hashsum).value;
                });
                var url = billingUrl
                    + '?yaml=' + encodeURIComponent(yml)
                    + '&pkgid=' + packageId;
                window.location = url;
            }
        </script>
    </body>
</html>
